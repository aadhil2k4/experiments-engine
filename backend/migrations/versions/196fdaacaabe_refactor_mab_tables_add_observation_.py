"""refactor MAB tables; add observation table

Revision ID: 196fdaacaabe
Revises: 618c33e41197
Create Date: 2025-03-05 17:01:32.720856

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "196fdaacaabe"
down_revision: Union[str, None] = "618c33e41197"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "arms_base",
        sa.Column("arm_id", sa.Integer(), nullable=False),
        sa.Column("experiment_id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=False),
        sa.Column("name", sa.String(length=150), nullable=False),
        sa.Column("description", sa.String(length=500), nullable=False),
        sa.Column("arm_type", sa.String(length=50), nullable=False),
        sa.ForeignKeyConstraint(
            ["experiment_id"],
            ["experiments_base.experiment_id"],
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.user_id"],
        ),
        sa.PrimaryKeyConstraint("arm_id"),
    )
    op.create_table(
        "contextual_observations",
        sa.Column("observation_id", sa.Integer(), nullable=False),
        sa.Column("arm_id", sa.Integer(), nullable=False),
        sa.Column("experiment_id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=False),
        sa.Column("reward", sa.Float(), nullable=True),
        sa.Column("context_val", postgresql.ARRAY(sa.Float()), nullable=False),
        sa.Column(
            "obs_timestamp_utc",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["arm_id"],
            ["contextual_arms.arm_id"],
        ),
        sa.ForeignKeyConstraint(
            ["experiment_id"],
            ["contextual_mabs.experiment_id"],
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.user_id"],
        ),
        sa.PrimaryKeyConstraint("observation_id"),
    )
    op.create_table(
        "mab_arms",
        sa.Column("arm_id", sa.Integer(), nullable=False),
        sa.Column("alpha", sa.Float(), nullable=True),
        sa.Column("beta", sa.Float(), nullable=True),
        sa.Column("mu", sa.Float(), nullable=True),
        sa.Column("sigma", sa.Float(), nullable=True),
        sa.ForeignKeyConstraint(["arm_id"], ["arms_base.arm_id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("arm_id"),
    )
    op.create_table(
        "observations_base",
        sa.Column("observation_id", sa.Integer(), nullable=False),
        sa.Column("arm_id", sa.Integer(), nullable=False),
        sa.Column("experiment_id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=False),
        sa.Column("observed_datetime_utc", sa.DateTime(timezone=True), nullable=False),
        sa.Column("obs_type", sa.String(length=50), nullable=False),
        sa.ForeignKeyConstraint(
            ["arm_id"],
            ["arms_base.arm_id"],
        ),
        sa.ForeignKeyConstraint(
            ["experiment_id"],
            ["experiments_base.experiment_id"],
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.user_id"],
        ),
        sa.PrimaryKeyConstraint("observation_id"),
    )
    op.create_table(
        "mab_observations",
        sa.Column("observation_id", sa.Integer(), nullable=False),
        sa.Column("reward", sa.Float(), nullable=False),
        sa.ForeignKeyConstraint(
            ["observation_id"], ["observations_base.observation_id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("observation_id"),
    )
    op.drop_table("arms")
    op.add_column(
        "contexts", sa.Column("value_type", sa.String(length=50), nullable=False)
    )
    op.drop_column("contexts", "weight")
    op.drop_column("contexts", "values")
    op.add_column("contextual_arms", sa.Column("mu_init", sa.Float(), nullable=False))
    op.add_column(
        "contextual_arms", sa.Column("sigma_init", sa.Float(), nullable=False)
    )
    op.add_column(
        "contextual_arms", sa.Column("mu", postgresql.ARRAY(sa.Float()), nullable=False)
    )
    op.add_column(
        "contextual_arms",
        sa.Column("covariance", postgresql.ARRAY(sa.Float()), nullable=False),
    )
    op.drop_column("contextual_arms", "failures")
    op.drop_column("contextual_arms", "successes")
    op.drop_column("contextual_arms", "beta_prior")
    op.drop_column("contextual_arms", "alpha_prior")
    op.add_column(
        "contextual_mabs", sa.Column("prior_type", sa.String(length=50), nullable=False)
    )
    op.add_column(
        "contextual_mabs",
        sa.Column("reward_type", sa.String(length=50), nullable=False),
    )
    op.add_column(
        "experiments_base",
        sa.Column("prior_type", sa.String(length=50), nullable=False),
    )
    op.add_column(
        "experiments_base",
        sa.Column("reward_type", sa.String(length=50), nullable=False),
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("experiments_base", "reward_type")
    op.drop_column("experiments_base", "prior_type")
    op.drop_column("contextual_mabs", "reward_type")
    op.drop_column("contextual_mabs", "prior_type")
    op.add_column(
        "contextual_arms",
        sa.Column("alpha_prior", sa.INTEGER(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "contextual_arms",
        sa.Column("beta_prior", sa.INTEGER(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "contextual_arms",
        sa.Column(
            "successes",
            postgresql.ARRAY(sa.INTEGER()),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "contextual_arms",
        sa.Column(
            "failures",
            postgresql.ARRAY(sa.INTEGER()),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.drop_column("contextual_arms", "covariance")
    op.drop_column("contextual_arms", "mu")
    op.drop_column("contextual_arms", "sigma_init")
    op.drop_column("contextual_arms", "mu_init")
    op.add_column(
        "contexts",
        sa.Column(
            "values",
            postgresql.ARRAY(sa.INTEGER()),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "contexts",
        sa.Column(
            "weight",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.drop_column("contexts", "value_type")
    op.create_table(
        "arms",
        sa.Column("arm_id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("experiment_id", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=150), autoincrement=False, nullable=False),
        sa.Column(
            "description", sa.VARCHAR(length=500), autoincrement=False, nullable=True
        ),
        sa.Column("alpha_prior", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("beta_prior", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("successes", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("failures", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.ForeignKeyConstraint(
            ["experiment_id"], ["mabs.experiment_id"], name="arms_experiment_id_fkey"
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["users.user_id"], name="arms_user_id_fkey"
        ),
        sa.PrimaryKeyConstraint("arm_id", name="arms_pkey"),
    )
    op.drop_table("mab_observations")
    op.drop_table("observations_base")
    op.drop_table("mab_arms")
    op.drop_table("contextual_observations")
    op.drop_table("arms_base")
    # ### end Alembic commands ###
